<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Traits\OutgoingMessagesTrait;

class EmailSendingApiController extends Controller
{
    use OutgoingMessagesTrait;

    public function storeEmailRequest(Request $request){

        $validated = $request->validate([
            'payload' => ['required']
        ]);

        $data = json_decode($request->payload, true);
        $allowed_IPs = [
            '35.187.65.170',
            '::1'
        ];
        $domain = strtolower(explode('@', $data['to'])[1]);
        if($domain != 'arikair.com'){
            return [
              'status' => 'failed',
              'message' => 'email domain not allowed'
            ];
        }

        if(!in_array($_SERVER['REMOTE_ADDR'], $allowed_IPs)){
            return [
              'status' => 'failed',
              'message' => 'request IP address not authorized'
            ];
        }

        if(isset($data['subject']) && isset($data['line']) && isset($data['to'])) {
            $this->storeMessage($data, null);
            return [
                'status' => 'successful',
                'message' => 'Email queued for sending'
            ];
        }else{
            return [
                'status' => 'failed',
                'message' => 'Incomplete data sent'
            ];
        }

    }
}
