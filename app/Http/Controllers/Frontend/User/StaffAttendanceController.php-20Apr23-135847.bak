<?php

namespace App\Http\Controllers\Frontend\User;

use App\Http\Controllers\Controller;
use App\Models\StaffAttendance;
use App\Models\StaffMember;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;

class StaffAttendanceController extends Controller
{
    public function index()
    {
        $todays_attendances = StaffAttendance::select(['direction', 'created_at'])->whereDate('created_at', Carbon::today())->get();
        $stats['ins'] = $todays_attendances->where('direction', 'in')->count();
        $stats['outs'] = $todays_attendances->where('direction', 'out')->count();
        $stats['on_prem'] = $stats['ins'] - $stats['outs'];

//        dd($stats);
        return view('frontend.staff_attendance.index')->with([
            'stats' => $stats
        ]);
    }

    public function checkStaffInfo(Request $request)
    {
        $staff = StaffMember::where('staff_ara_id', $request->staff_ara_id)->first();
        if(!$staff){
            return [
                'msg' => 'No Staff with matching ARA number found',
                'attendance_entered' => false
            ];
        }

        $todays_attendances = StaffAttendance::where('staff_ara_id', $staff->staff_ara_id)->whereDate('created_at', Carbon::today())->get();

        return [
            'todays_attendances' => $todays_attendances,
            'staff_member' => $staff
        ];

    }

    public function checkARANumber(Request $request)
    {
        $staff = StaffMember::where('staff_ara_id', $request->staff_ara_id)->first();
        if(!$staff){
            return [
              'msg' => 'No Staff with matching ARA number found',
              'attendance_entered' => false
            ];
        }

        $now = Carbon::now();
        //check status
        $attendance_entered = false;
        if($staff->status == 'active' && is_null($staff->restrict_access_from)) {
            $attendance = new StaffAttendance();
            $attendance->operator_user_id = $request->operator_user_id;
            $attendance->staff_ara_id = $staff->staff_ara_id;
            $attendance->ip_address = $request->getClientIp();
            $attendance->meridien = date('A');
            $attendance->seconds = date('s');
            $attendance->minutes = date('i');
            $attendance->hour = date('H');
            $attendance->day = date('d');
            $attendance->week_day = date('l');
            $attendance->month = date('F');
            $attendance->year = date('Y');
            $attendance->temperature = $request->temperature;

            $previous_attendance_for_today = StaffAttendance::where('staff_ara_id', $staff->staff_ara_id)->whereDate('created_at', Carbon::today())->latest()->first();
            if (!$previous_attendance_for_today) {
                $attendance->direction = 'in';
            } else if ($previous_attendance_for_today->direction == 'in') {
                $attendance->direction = 'out';
            } else {
                $attendance->direction = 'in';
            }

            $attendance->save();
            $attendance_entered = true;

            return [
                'attendance_entered' => $attendance_entered,
                'nows_attendance' => $attendance,
                'staff_member' => $staff
            ];
        }

        return [
            'attendance_entered' => $attendance_entered,
            'staff_member' => $staff
        ];

    }

    public function viewMultipleStaffAttendance(Request $request)
    {
        $auth_user = auth()->user();
        // define date range
        if($request->filled('from_date')){
            $from_date = Carbon::parse($request->from_date);
        }else{
            $from_date = Carbon::now()->startOfMonth();
        }

        if($request->filled('to_date')){
            $to_date = Carbon::parse($request->to_date);
        }else{
            $to_date = Carbon::now();
        }

//        $staff_members = StaffMember::select(['surname', 'other_names', 'staff_ara_id', 'department_name'])->where('staff_ara_id', 6575)->get();
//        $staff_members = StaffMember::select(['surname', 'other_names', 'staff_ara_id', 'department_name'])->get();


        if($auth_user->can('manage all staff attendance')){
            $staff_members = StaffMember::select(['surname', 'other_names', 'staff_ara_id', 'department_name'])
//                ->where('staff_ara_id', '6878')
                ->orderBy('staff_ara_id', 'ASC')
                ->get();
        }else if($auth_user->can('manage own unit info')){
            $staff_members = StaffMember::select(['surname', 'other_names', 'staff_ara_id', 'department_name'])
                ->where('department_name', $auth_user->department_name)
                ->orderBy('staff_ara_id', 'ASC')
                ->get();
        }else{
            $staff_members = StaffMember::select(['surname', 'other_names', 'staff_ara_id', 'department_name'])->where('email', $auth_user->email)
                ->orderBy('staff_ara_id', 'ASC')
                ->get();
        }

        // testing purposes
//        $staff_members = StaffMember::select(['surname', 'other_names', 'staff_ara_id', 'department_name'])->take(20)->get();

        return view('frontend.staff_attendance.multiple_staff_attendance_records')->with([
            'staff_members' => $staff_members,
            'staff_members_json' => json_encode($staff_members),
                'from_date' => $from_date,
                'to_date' => $to_date
        ]);

    }

    public function viewIndividualStaffAttendance(Request $request)
    {

        $validated = $request->validate([
           'staff_ara_id' => [
               'required',
               'numeric',
               'exists:staff_member_details,staff_ara_id'
           ],
            'from_date' => [
                'date',
                'before:to_date'
            ],
            'to_date' => [
                'date',
                'after:from_date'
            ],
        ]);

        $auth_user = auth()->user();

        if($auth_user->can('manage all staff attendance') || $auth_user->can('manage own unit info')){
            // TODO: separate the above condition for unit and for the whole firm
            $staff_ara_id = $request->staff_ara_id;
        }else{
            $staff_ara_id = $auth_user->staff_member->staff_ara_id;
        }

        $staff = StaffMember::where('staff_ara_id', $staff_ara_id)->first();

        if($request->filled('from_date')){
            $from_date = Carbon::createFromFormat('Y-m-d',$request->from_date)->format('Y-m-d');
            $from_date_temp = Carbon::createFromFormat('Y-m-d', $request->from_date)->format('Y-m-d');
        }else{
            $from_date = Carbon::now()->startOfMonth();
            $from_date_temp = Carbon::now()->startOfMonth();
        }

        if($request->filled('to_date')){
            $to_date = $request->to_date;
        }else{
            $to_date = Carbon::now();
        }

        for($date = $from_date_temp; $date <= $to_date; $date->addDay()){
            $attendances[$staff_ara_id][$date->toDateString()]['movements'] = StaffAttendance::where('staff_ara_id', $staff_ara_id)->whereBetween('created_at', [$date->startOfDay()->toDateTimeString(), $date->endOfDay()->toDateTimeString()])->get();
            $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'] = 0;
//            dd($attendances[$staff_ara_id][$date->toDateString()]['movements']);
            if(count($attendances[$staff_ara_id][$date->toDateString()]['movements']) >= 2) {

                $first_in = $attendances[$staff_ara_id][$date->toDateString()]['movements']
                    ->where('direction', 'in')
                    ->sortBy('id')
                    ->first();
                $last_out = $attendances[$staff_ara_id][$date->toDateString()]['movements']
                    ->where('direction', 'out')
                    ->sortByDesc('id')
                    ->first();

//                $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'] = $last_out->created_at->diffInHours($first_in->created_at);
                $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'] = $this->calcHoursInPrem($staff_ara_id, $date->toDateString());
                $days_attendance[] = [
                    'date' => $date->toDateString(),
                    'resumed' => $first_in->hour.':'.$first_in->minutes,
                    'closed' => $last_out->hour.':'.$last_out->minutes,
                    'hours' => $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'],
                    'weekday' => $first_in->week_day
                ];
            }else{
                $days_attendance[] = [
                    'date' => $date->toDateString(),
                    'resumed' => '-',
                    'closed' => '-',
                    'hours' => 0,
                    'weekday' => $date->dayName
                ];
            }
        }


        return view('frontend.staff_attendance.individual_staff_attendance_records')
            ->with([
               'staff' => $staff,
               'attendances' => $days_attendance,
                'from_date' => $from_date,
                'to_date' => $to_date
            ]);
    }

    public function getIndividualStaffAttendance(Request $request)
    {
        $validated = $request->validate([
            'staff_ara_id' => [
                'required',
                'numeric',
                'exists:staff_member_details,staff_ara_id'
            ],
            'from_date' => [
                'date',
                'before:to_date'
            ],
            'to_date' => [
                'date',
                'after:from_date'
            ],
        ]);

        $staff_ara_id = $request->staff_ara_id;
        $staff = StaffMember::where('staff_ara_id', $staff_ara_id)->first();

        // define date range
        if($request->filled('from_date')){
            $from_date = $request->from_date;
            $from_date_temp = $request->from_date;
        }else{
            $from_date = Carbon::now()->startOfMonth();
            $from_date_temp = Carbon::now()->startOfMonth();
        }

        if($request->filled('to_date')){
            $to_date = $request->to_date;
        }else{
            $to_date = Carbon::now();
        }

        for($date = $from_date_temp; $date <= $to_date; $date->addDay()){
            $attendances[$staff_ara_id][$date->toDateString()]['movements'] = StaffAttendance::where('staff_ara_id', $staff_ara_id)->whereBetween('created_at', [$date->startOfDay()->toDateTimeString(), $date->endOfDay()->toDateTimeString()])->get();
            $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'] = 0;
//            dd($attendances[$staff_ara_id][$date->toDateString()]['movements']);

            $count_attendance = isset($attendances[$staff_ara_id][$date->toDateString()]['movements']) ? count($attendances[$staff_ara_id][$date->toDateString()]['movements']) : 0;
//            if(!$count_attendance)
//                $count_attendance = 0;

            $attendances[$staff_ara_id][$date->toDateString()]['schedule'] = $this->checkDaySchedule($staff_ara_id, $date->toDateString(), $count_attendance);
            if($count_attendance >= 2) {
                $first_in = $attendances[$staff_ara_id][$date->toDateString()]['movements']
                    ->where('direction', 'in')
                    ->sortBy('id')
                    ->first();
                $last_out = $attendances[$staff_ara_id][$date->toDateString()]['movements']
                    ->where('direction', 'out')
                    ->sortByDesc('id')
                    ->first();

//                $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'] = $last_out->created_at->diffInHours($first_in->created_at);
                $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'] = $this->calcHoursInPrem($staff_ara_id, $date->toDateString());
                $days_attendance[] = [
                    'date' => $date->toDateString(),
                    'resumed' => $first_in->hour.':'.$first_in->minutes,
                    'closed' => $last_out->hour.':'.$last_out->minutes,
                    'hours' => $attendances[$staff_ara_id][$date->toDateString()]['hours on prem'],
                    'weekday' => $first_in->week_day,
                    'day_schedule' => $this->checkDaySchedule($staff_ara_id, $date, count($attendances[$staff_ara_id][$date->toDateString()]['movements']))
                ];
            }else{
                $days_attendance[] = [
                    'date' => $date->toDateString(),
                    'resumed' => '-',
                    'closed' => '-',
                    'hours' => 0,
                    'weekday' => $date->dayName,
                    'day_schedule' => $this->checkDaySchedule($staff_ara_id, $date, count($attendances[$staff_ara_id][$date->toDateString()]['movements']))
                ];
            }
        }

        return response()->json([
                'staff' => $staff,
                'attendances' => $days_attendance,
                'from_date' => $from_date,
                'to_date' => $to_date
            ], 200);
    }

    public function hoursOnPrem(Request $request)
    {
        $validated = $request->validate([
            'staff_ara_id' => ['required'],
            'date' => ['required', 'date'],
        ]);

        $arr['hours'] = $this->calcHoursInPrem($validated['staff_ara_id'], $validated['date']);
        return array_merge($validated, $arr);
    }

    public function calcHoursInPrem($staffAraId, $date)
    {
        $date = Carbon::parse($date);
// Retrieve the staff's attendance records for the given date
        $attendances = DB::table('staff_attendances')
            ->where('staff_ara_id', $staffAraId)
            ->whereDate('created_at', $date)
            ->orderBy('created_at')
            ->get();

        $inTime = null;
        $outTime = null;
        $totalHours = 0;

// Loop through the attendance records
        foreach ($attendances as $attendance) {
            if ($attendance->direction === 'in') {
                $inTime = Carbon::parse($attendance->created_at);
            } elseif ($attendance->direction === 'out') {
                $outTime = Carbon::parse($attendance->created_at);

                // Calculate the duration between the in and out times
                $duration = $inTime->diffInMinutes($outTime) / 60.0;
                $totalHours += $duration;

                $inTime = null;
                $outTime = null;
            }
        }

        return $totalHours;
    }

    public function checkDayScheduletest(Request $request)
    {
        return $this->checkDaySchedule($request->ara, $request->date, $request->ct);
    }

    public function checkDaySchedule($staffAraId, $date, $attendance_count = null)
    {
        $date = Carbon::parse($date);
        $schedule = DB::table('staff_remote_schedules')
                    ->where('staff_ara_id', $staffAraId)
            ->where('week_day', strtolower($date->format('l')))
            ->first();
        $show = 'show';
        if(is_null($attendance_count) || $attendance_count == 0)
            $show = 'no show';

        $workdays = [
          'monday',
          'tuesday',
          'wednesday',
            'friday',
            'thursday',
        ];

        if(!in_array(strtolower($date->format('l')), $workdays)){
            $location = 'Remote';
            $show = 'weekend';
        }else if(!$schedule || $schedule->location == 'On-site'){
            $location = 'On-site';
        }else{
            $location = $schedule->location;
        }


        $colors = [
            'On-site - no show' => '#f06543',
            'On-site - show' => '#FFFFFF',
//            'Remote - no show' => '#4cb944',
            'Remote - no show' => '#FFFFFF',
            'Remote - show' => '#f5ee9e',
            'Remote - weekend' => '#4cb944'
        ];

        $data = [
            'location' => $location,
            'colour' => $colors[$location.' - '.$show],
            'weekday' => strtolower($date->format('l')),
            'schedule' => $schedule
        ];
        return $data;
    }
}
